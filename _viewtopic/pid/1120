<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>forum.bittorrent-archive.mythra.dev / µTorrent sending weird µTP packets</title>
<link rel="stylesheet" type="text/css" href="style/Kontrast.css" />
</head>
<body>

<div id="punwrap">
<div id="punviewtopic" class="pun">

<div id="brdheader" class="block">
	<div class="box">
		<div id="brdtitle" class="inbox">
			<h1><span>forum.bittorrent-archive.mythra.dev</span></h1>
			<p><span>BitTorrent.org community</span></p>
		</div>
		<div id="brdmenu" class="inbox">
			<ul>
				<li id="navindex"><a href="index.php">Index</a></li>
				<li id="navextra1"><a href="http://forum.bittorrent-archive.mythra.dev">Homepage</a></li>
				<li id="navextra2"><a href="irc://irc.freenode.net/bittorrent">IRC</a></li>
				<li id="navuserlist"><a href="userlist.php">User list</a></li>
				<li id="navrules"><a href="misc.php?action=rules">Rules</a></li>
				<li id="navsearch"><a href="search.php">Search</a></li>
				<li id="navregister"><a href="register.php">Register</a></li>
				<li id="navlogin"><a href="login.php">Login</a></li>
			</ul>
		</div>
		<div id="brdwelcome" class="inbox">
			<p>You are not logged in.</p>
		</div>
	</div>
</div>

<div id="announce" class="block">
	<h2><span>Announcement</span></h2>
	<div class="box">
		<div class="inbox">
			<div>Posting about any illegal sharing of copyrighted content is strictly forbidden.</div>
		</div>
	</div>
</div>

<div class="linkst">
	<div class="inbox">
		<p class="pagelink conl">Pages: <strong>1</strong></p>
		<p class="postlink conr">&nbsp;</p>
		<ul><li><a href="index.php">Index</a></li><li>&nbsp;&raquo;&nbsp;<a href="viewforum.php?id=25">BEPs</a></li><li>&nbsp;&raquo;&nbsp;µTorrent sending weird µTP packets</li></ul>
		<div class="clearer"></div>
	</div>
</div>

<div id="p992" class="blockpost rowodd firstpost">
	<h2><span><span class="conr">#1&nbsp;</span><a href="viewtopic.php?pid=992#p992">2010-02-23 10:58:47</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89612">George</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3>µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>Is BEP 29 incomplete ? Because µTorrent seems to be sending µTP which does not confirm to the standard. Take a look at these packets (which should be SYN packets) :<br /><br />f2 ee 95 50 <br />4b 81 94 af <br />00 05 19 a3 <br />7f ff ff ff <br />ab 02 04 00 <br />01 00 00 00 <br />08 00 00 00 <br />00 00 00 00 <br />00 <br /><br />e2 6f ea 8f <br />4b 82 c1 f8 <br />00 0b 85 13 <br />7f ff ff ff <br />ab 02 04 00 <br />01 00 00 00 <br />08 00 00 00 <br />00 00 00 00<br />00 <br /><br />e2 6f ea 8f <br />4b 82 c1 ee <br />00 03 83 6e <br />7f ff ff ff <br />ab 02 04 00 <br />01 00 00 00 <br />08 00 00 00 <br />00 00 00 00 <br />00<br /><br />ff 3e 6a b3 <br />4b 82 c5 15 <br />00 0b 9e 58 <br />7f ff ff ff <br />ab 02 04 00 <br />01 00 00 00 <br />08 00 00 00 <br />00 00 00 00 <br />00 <br /><br />95 e6 73 8e <br />4b 84 1f 35 <br />00 06 75 18 <br />7f ff ff ff <br />ab 02 04 00 <br />01 00 00 00 <br />08 00 00 00 <br />00 00 00 00 <br />00 <br /><br />These are dumps of packets sent by µTorrent, trying to connect to my client. The first 4 bytes appear to be totally random. Does not look like BEP 29 at all.</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p994" class="blockpost roweven">
	<h2><span><span class="conr">#2&nbsp;</span><a href="viewtopic.php?pid=994#p994">2010-02-23 12:20:27</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=90000">DreadWingKnight</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>How totally random?<br />What are you using to packet capture?</p>
				</div>
				<div class="postsignature"><hr />Guy with a few torrent programs under his belt.</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p998" class="blockpost rowodd">
	<h2><span><span class="conr">#3&nbsp;</span><a href="viewtopic.php?pid=998#p998">2010-02-24 08:59:44</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89612">George</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<blockquote><div class="incqbox"><p>How totally random?</p></div></blockquote><p>I don't see a pattern. The first 2 bytes should be the same for all of these packets.<br /><br /></p><blockquote><div class="incqbox"><p>What are you using to packet capture?</p></div></blockquote><p>I'm just dumping the packets to a file. I have also used wireshark to confirm that what I dump is actually in the UDP packet.</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1000" class="blockpost roweven">
	<h2><span><span class="conr">#4&nbsp;</span><a href="viewtopic.php?pid=1000#p1000">2010-02-24 09:35:09</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=90000">DreadWingKnight</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>Could you post a copy of the wireshark capture of the traffic?</p>
				</div>
				<div class="postsignature"><hr />Guy with a few torrent programs under his belt.</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1002" class="blockpost rowodd">
	<h2><span><span class="conr">#5&nbsp;</span><a href="viewtopic.php?pid=1002#p1002">2010-02-25 08:59:36</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89612">George</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>This is a trace of 3 uTP packets sent by µTorrent, when it is trying to setup a connection to ktorrent:<br /><br /><a href="http://ktorrent.org/downloads/utorrent_utp.trace" rel="nofollow">http://ktorrent.org/downloads/utorrent_utp.trace</a></p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1008" class="blockpost roweven">
	<h2><span><span class="conr">#6&nbsp;</span><a href="viewtopic.php?pid=1008#p1008">2010-02-28 02:30:51</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89612">George</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>Here is a trace of two µTorrent clients talking to each other over µTP:<br /><br /><a href="http://ktorrent.org/downloads/utp_trace.cap" rel="nofollow">http://ktorrent.org/downloads/utp_trace.cap</a><br /><br />Looking at the packets I'm beginning to think that:<br /><br />- The last 10 bytes of the first packets is the extension bits extension<br />- byte 19 is the type<br />- bytes 20 and 21 are the seq_nr<br />- bytes 22 and 23 are the ack_nr<br /><br />Looks like the 23 byte long packets are state packets</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1010" class="blockpost rowodd">
	<h2><span><span class="conr">#7&nbsp;</span><a href="viewtopic.php?pid=1010#p1010">2010-02-28 03:05:20</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89612">George</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>Also bytes 3 and 4 or the first 4 bytes are the connection id</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1012" class="blockpost roweven">
	<h2><span><span class="conr">#8&nbsp;</span><a href="viewtopic.php?pid=1012#p1012">2010-02-28 09:40:20</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89612">George</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>Bytes 5 to 8 look like the number of seconds since the epoch (so tv_sec in a struct timeval)<br />And bytes 9 to 12 appear to be the number of microseconds (tv_usec in a struct timeval), it is always smaller then a million.</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1014" class="blockpost rowodd">
	<h2><span><span class="conr">#9&nbsp;</span><a href="viewtopic.php?pid=1014#p1014">2010-02-28 09:46:16</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89612">George</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>So in short, there is a standard, and µTorrent doesn't follow it, and I'm left reverse engineering the protocol. How nice.</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1016" class="blockpost roweven">
	<h2><span><span class="conr">#10&nbsp;</span><a href="viewtopic.php?pid=1016#p1016">2010-02-28 22:34:31</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89602">arvid</a></strong></dt>
					<dd class="usertitle"><strong>Administrator</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>set bit 16 in bt.trans_disposition on uT and it will use the header specified in BEP29.<br /><br />This is supported by all 2.0+ clients, but not by previous versions, that's why the default is still the old version of the header. We'll change this in 2.0.1.</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1018" class="blockpost rowodd">
	<h2><span><span class="conr">#11&nbsp;</span><a href="viewtopic.php?pid=1018#p1018">2010-02-28 22:36:52</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89602">arvid</a></strong></dt>
					<dd class="usertitle"><strong>Administrator</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<blockquote><div class="incqbox"><h4>George wrote:</h4><p>So in short, there is a standard, and µTorrent doesn't follow it, and I'm left reverse engineering the protocol. How nice.</p></div></blockquote><p>Did you try to connect to a uT client with the specified protocol? That should work (and it has in all my tests so far).</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1026" class="blockpost roweven">
	<h2><span><span class="conr">#12&nbsp;</span><a href="viewtopic.php?pid=1026#p1026">2010-03-01 11:27:51</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89612">George</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>With bit 16 set, I get different packets, but still packets with 23 byte headers. The first byte seems to be OK though (version and type look OK, though the nibbles are not in the expected order)<br /><br />Here is the trace:<br /><br /><a href="http://ktorrent.org/downloads/utp_new_header.trace" rel="nofollow">http://ktorrent.org/downloads/utp_new_header.trace</a><br /><br />Looking closely, I'm beginning to suspect that µTorrent is not fully following BEP29, what should be the first byte (type and version) appear to be the first 4 bytes.<br /><br />It is almost like they put the type and version in a 32 bit unsigned int and write that to the header. The rest of the header appears to be OK. Could be struct alignment, or something like that.</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1034" class="blockpost rowodd">
	<h2><span><span class="conr">#13&nbsp;</span><a href="viewtopic.php?pid=1034#p1034">2010-03-01 14:45:05</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89602">arvid</a></strong></dt>
					<dd class="usertitle"><strong>Administrator</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>This is the header used in uTorrent:<br /><br />#pragma pack(push,1)<br />struct PacketFormatV1 {<br />&nbsp; &nbsp;uint version:4;<br />&nbsp; &nbsp;uint type:4;<br />&nbsp; &nbsp;byte ext;<br />&nbsp; &nbsp;uint16_big connid;<br />&nbsp; &nbsp;uint32_big tv_usec;<br />&nbsp; &nbsp;uint32_big reply_micro;<br />&nbsp; &nbsp;uint32_big windowsize;<br />&nbsp; &nbsp;uint16_big seq_nr;<br />&nbsp; &nbsp;uint16_big ack_nr;<br />};<br />#pragma pack(pop)<br /><br />which seems to match the header in BEP 29.</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1038" class="blockpost roweven">
	<h2><span><span class="conr">#14&nbsp;</span><a href="viewtopic.php?pid=1038#p1038">2010-03-01 14:53:14</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89602">arvid</a></strong></dt>
					<dd class="usertitle"><strong>Administrator</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>At a closer inspection, it seems like this struct was in fact not packed. That's bad. I will fix this for the 2.0.1 release.</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1050" class="blockpost rowodd">
	<h2><span><span class="conr">#15&nbsp;</span><a href="viewtopic.php?pid=1050#p1050">2010-03-02 08:41:56</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89612">George</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>When are you planning to release 2.0.1 ?</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1052" class="blockpost roweven">
	<h2><span><span class="conr">#16&nbsp;</span><a href="viewtopic.php?pid=1052#p1052">2010-03-03 05:03:50</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=89609">Olaf van der Spek</a></strong></dt>
					<dd class="usertitle"><strong>Member</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>Is the first byte a bitfield? Isn't the layout of it implementation dependend?</p>
				</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div id="p1120" class="blockpost rowodd">
	<h2><span><span class="conr">#17&nbsp;</span><a href="viewtopic.php?pid=1120#p1120">2010-03-15 14:18:48</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postleft">
				<dl>
					<dt><strong><a href="profile.php?id=725">Firon</a></strong></dt>
					<dd class="usertitle"><strong>Administrator</strong></dd>
					<dd class="postavatar"></dd>
				</dl>
			</div>
			<div class="postright">
				<h3> Re: µTorrent sending weird µTP packets</h3>
				<div class="postmsg">
					<p>George: within the next two weeks.<br />We also hotfixed 2.0 with the correct header (and autoupdated everyone).</p>
				</div>
				<div class="postsignature"><hr />Please read the <a href="http://forum.utorrent.com/viewtopic.php?id=458" rel="nofollow">rules</a> before posting.</div>
			</div>
			<div class="clearer"></div>
			<div class="postfootleft"><p>Offline</p></div>
			<div class="postfootright"><div>&nbsp;</div></div>
		</div>
	</div>
</div>

<div class="postlinksb">
	<div class="inbox">
		<p class="postlink conr">&nbsp;</p>
		<p class="pagelink conl">Pages: <strong>1</strong></p>
		<ul><li><a href="index.php">Index</a></li><li>&nbsp;&raquo;&nbsp;<a href="viewforum.php?id=25">BEPs</a></li><li>&nbsp;&raquo;&nbsp;µTorrent sending weird µTP packets</li></ul>
		<div class="clearer"></div>
	</div>
</div>

<div id="brdfooter" class="block">
	<h2><span>Board footer</span></h2>
	<div class="box">
		<div class="inbox">

			<div class="conl">
				<form id="qjump" method="get" action="viewforum.php">
					<div><label>Jump to
					<br /><select name="id" onchange="window.location=('viewforum.php?id='+this.options[this.selectedIndex].value)">
						<optgroup label="BitTorrent">
							<option value="26">Announcements</option>
							<option value="27">General</option>
							<option value="25" selected="selected">BEPs</option>
							<option value="29">BEP process</option>
							<option value="33">Research Tools</option>
							<option value="32">Cooperation between BitTorrent and ISPs</option>
							<option value="30">Attacks against BitTorrent</option>
							<option value="28">Feature Requests, Found Bugs &gt;&gt;&gt;</option>
					</optgroup>
					</select>
					<input type="submit" value=" Go " accesskey="g" />
					</label></div>
				</form>
			</div>
			<p class="conr">Powered by <a href="http://fluxbb.org/">FluxBB</a></p>
			<div class="clearer"></div>
		</div>
	</div>
</div>

</div>
</div>

<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
_uacct = "UA-116155-1";
_udn = "utorrent.com";
urchinTracker();
</script>

</body>
</html>
