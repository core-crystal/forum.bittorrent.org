<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Discussion of BEP 5: DHT (Page 1) / BEPs / forum.bittorrent.org</title>
<link rel="stylesheet" type="text/css" href="style/Air.css" />
<link rel="stylesheet" type="text/css" href="captcha/css/style.css" />
<link rel="stylesheet" type="text/css" href="captcha/css/redmond/jquery-ui-1.8.21.custom.css" />
<script type="text/javascript" src="captcha/js/jquery-1.7.2.min.js"></script>
<script type="text/javascript" src="captcha/js/jquery-ui-1.8.21.custom.min.js"></script>
<script type="text/javascript" src="captcha/js/jquery.ui.touch-punch.min.js"></script>
<script type="text/javascript">
	$(function(){var f=$("#sliderCaptcha");var b=$("#cleCaptcha");var d=$(".boutonsCaptcha");var a=$("#javascriptCaptcha");var e=[30,1,36,48,10,32,6,31,24,37,17,3,46,31,40,37,46,40,1,25,14,29,13,43,48,39,4,29,6,41,0,37,42,37,35,3,20,42,35,44,29,3,47,25,34,37,13,30,28,15];var h=0;var g=5;var c=0;a.hide();f.slider({value:0,min:0,max:g,step:1,slide:function(i,j){if(j.value>c){c=j.value;h+=c}},stop:function(j,k){var i=false;if(k.value==g){if(h==((g+Math.pow(g,2))/2)){i=true;f.slider("option","disabled",true);if(b.val().length!=e.length){$.post("captcha.php",{tokenCaptcha:b.val()},function(m){var l="";$.each(e,function(){l+=m.charAt(this%m.length)});b.val(l);d.removeAttr("disabled")})}}}if(!i){h=c=0;f.slider("option","value",h)}}})});
</script>
<!--[if lte IE 6]><script type="text/javascript" src="style/imports/minmax.js"></script><![endif]-->
</head>

<body>

<div id="punviewtopic" class="pun">
<div class="top-box"><div><!-- Top Corners --></div></div>
<div class="punwrap">

<div id="brdheader" class="block">
	<div class="box">
		<div id="brdtitle" class="inbox">
			<h1><a href="index.php">forum.bittorrent.org</a></h1>
			<div id="brddesc">BitTorrent.org community</div>
		</div>
		<div id="brdmenu" class="inbox">
			<ul>
				<li id="navindex" class="isactive"><a href="index.php">Index</a></li>
				<li id="navextra1"><a href="http://bittorrent.org">Homepage</a></li>
				<li id="navextra2"><a href="https://groups.google.com/a/bittorrent.com/forum/#!forum/bt-developers">Mailing List</a></li>
				<li id="navextra3"><a href="irc://irc.freenode.net/bittorrent">IRC</a></li>
				<li id="navuserlist"><a href="userlist.php">User list</a></li>
				<li id="navrules"><a href="misc.php?action=rules">Rules</a></li>
				<li id="navsearch"><a href="search.php">Search</a></li>
				<li id="navregister"><a href="register.php">Register</a></li>
				<li id="navlogin"><a href="login.php">Login</a></li>
			</ul>
		</div>
		<div id="brdwelcome" class="inbox">
			<p class="conl">You are not logged in.</p>
			<ul class="conr">
				<li><span>Topics: <a href="search.php?action=show_recent" title="Find topics with recent posts.">Active</a> | <a href="search.php?action=show_unanswered" title="Find topics with no replies.">Unanswered</a></span></li>
			</ul>
			<div class="clearer"></div>
		</div>
	</div>
</div>

<div id="announce" class="block">
	<div class="hd"><h2><span>Announcement</span></h2></div>
	<div class="box">
		<div id="announce-block" class="inbox">
			<div class="usercontent">Forums are closed.
Use the new mailing list!
https://groups.google.com/a/bittorrent.com/forum/#!forum/bt-developers</div>
		</div>
	</div>
</div>

<div id="brdmain">
<div class="linkst">
	<div class="inbox crumbsplus">
		<ul class="crumbs">
			<li><a href="index.php">Index</a></li>
			<li><span>»&#160;</span><a href="viewforum.php?id=25">BEPs</a></li>
			<li><span>»&#160;</span><a href="viewtopic.php?id=12"><strong>Discussion of BEP 5: DHT</strong></a></li>
		</ul>
		<div class="pagepost">
			<p class="pagelink conl"><span class="pages-label">Pages: </span><strong class="item1">1</strong> <a href="viewtopic.php?id=12&amp;p=2">2</a> <a href="viewtopic.php?id=12&amp;p=2">Next</a></p>
		</div>
		<div class="clearer"></div>
	</div>
</div>

<div id="p31" class="blockpost rowodd firstpost blockpost1">
	<h2><span><span class="conr">#1</span> <a href="viewtopic.php?pid=31#p31">2008-03-04 13:00:43</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89601">dave</a></strong></dt>
						<dd class="usertitle"><strong>Editor</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>The DHT protocol has been implemented with some variation between BitComet, Azureus, BitTorrent Mainline, uTorrent, and others.&#160; </p><p>See <a href="http://www.bittorrent.org/beps/bep_0005.html">http://www.bittorrent.org/beps/bep_0005.html</a></p><p>In particular the Azureus DHT is different from the DHT introduced by mainline.&#160; Would anyone on the Azureus team care to document these differences or post a BEP for the Azureus DHT?</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p37" class="blockpost roweven">
	<h2><span><span class="conr">#2</span> <a href="viewtopic.php?pid=37#p37">2008-03-04 15:39:29</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89618">The 8472</a></strong></dt>
						<dd class="usertitle"><strong>Azureus Developer</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>Listing differences would not be adequate as it is a completely different implementention form the ground up, but here we go:<br />-we use a messaging protocol similar to the UDP tracker protocol<br />-messages are binary format (not bencoded)<br />-we also have UDP-based, congstion-controled transports in the DHT for bulk-data-transfer from nodes that advertise such data (such as .torrents for magnet links), which also allows sharing the UDP port with other things, by using different initial connection IDs<br />-there is the vivaldi coordinate system as RTT distance estimating for nodes we haven&#039;t seen before<br />-there us UDP hole punching for nat traversal (especially for said bulk transports)<br />-the implementation is closer to the kademlia spec as enhanced features like value propagation and replication on node churn is used<br />-there are several measures in place to cope with the britney effect, i.e. hotspots due to popular keys<br />-various precautions to prevent routing table poisoning attacks and other malicious behavior</p><p>and... those are just the things that come to mind right now. I recently helped optimizing an implementation of the mainline DHT as an azureus plugin, and i must say the complexity and featureset are vastly different.<br />Documenting it so sufficiently that others could implement properly would be a difficult task as many of the features build on each other.</p><br /><p>Edit:</p><p>The draft should include a currently non-standard feature used by ÂµT to my knowledge that indicates vendor (and version) of the used client. This could be used to notify developers of faulty implementations to fix their problems. It&#039;s annoying to look at some implementations seriously misbehaving and not being able to do anything about it.</p>
						<p class="postedit"><em>Last edited by The 8472 (2008-03-04 15:55:53)</em></p>
					</div>
					<div class="postsignature postmsg"><hr /><p>Az dev</p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p60" class="blockpost rowodd">
	<h2><span><span class="conr">#3</span> <a href="viewtopic.php?pid=60#p60">2008-03-05 15:25:25</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89601">dave</a></strong></dt>
						<dd class="usertitle"><strong>Editor</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>It sounds like a lot of effort has been put into the Azureus DHT.&#160; Admittedly much less effort has been put into the BitTorrent mainline DHT.&#160; Having a single DHT would benefit the community as it would not partition the users downloading the same file.&#160; However replicating all of the features in the Azureus DHT may be quite a hurdle for client developers.&#160; Does anyone on the Azureus team have a desire to formalize a subset of the features that would enable a functional single DHT without breaking your current implementation?</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p157" class="blockpost roweven">
	<h2><span><span class="conr">#4</span> <a href="viewtopic.php?pid=157#p157">2008-04-21 12:17:36</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89618">The 8472</a></strong></dt>
						<dd class="usertitle"><strong>Azureus Developer</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>A few suggestions about the DHT spec:</p><p>a) gets/announces</p><p>The token on getPeers replies should be optional and an algorithm when to provide it should be specified. This algorithm should enforce a minimum announce-interval and closeness to the destination key. This will prevent announce-put-hammering and storing announces in the wrong place.</p><p>In addition the <em>either</em> peers <em>or</em> nodes response policy (&quot;If the queried node has no peers for the infohash, a key &quot;nodes&quot; is returned containing the K nodes in the queried nodes routing table closest to the infohash supplied in the query.&quot;) should be changed to: always nodes, peers if available. This should improve routing performance, especially if the node cannot supply a sufficient amount of peers to satisfy the requesting peer, although the packet size might become problematic then... any opinions?<br />It might also be useful to completely withhold any peers information - even if available - if the specific node already sent a getPeers request within a certain min interval.</p><br /><p>My rationale for those proposals is that I&#039;m seeing inefficient implementations: after 13 hours of uptime my node sent the following requests:<br />16.4k find nodes, 1.8k get peers, 0.4k announces</p><p>but i received<br />118k find nodes, 91k get peers, 43k announces</p><p>I&#039;m suspecting bitcomet and/or xunlei here.</p><br /><p>Another issue i&#039;d like second opinions about is this:<br /></p><div class="codebox"><pre><code>[20:44:27] Node C40ED4C6 92F75BA6 D5C76174 05A4C0B5 6654777D changed address from /89.102.57.229:8488 to /91.145.65.181:22920
[20:44:36] New node /218.170.53.140:24364 claims same Node ID (C41A5BBE 50D93143 EDC08374 230540D6 72F610BF) as /124.13.91.107:8552 ; node dropped as this might be an impersonation attack
[20:45:10] New node /190.47.106.148:16138 claims same Node ID (C42CBC5E 756C404C 800E5657 B5AEFB1C 8AF8F8CD) as /61.15.174.158:25125 ; node dropped as this might be an impersonation attack
[20:45:14] Node C42BC344 D8082284 3F98603B 03CD7A04 A5388C1A changed address from /62.195.43.197:53804 to /79.114.153.213:14050
[20:45:47] Node C802C403 922FD99F 92FE2912 2867B8AA 4E8A0836 changed address from /89.77.104.146:55147 to /89.77.104.146:55170
[20:45:53] New node /212.233.229.17:3203 claims same Node ID (C4EEEC34 8930B75F A44B61B0 FC9CA196 991E58FC) as /81.88.114.195:42804 ; node dropped as this might be an impersonation attack
[20:46:02] New node /125.121.41.5:20639 claims same Node ID (C4EEEC34 8930B75F A44B61B0 FC9CA196 991E58FC) as /81.88.114.195:42804 ; node dropped as this might be an impersonation attack
[20:47:23] New node /87.110.24.186:8815 claims same Node ID (C449ACE1 952A488A 64AA4A3D 59D9D0B4 1F4A7039) as /77.93.13.116:13918 ; node dropped as this might be an impersonation attack
[20:48:41] New node /121.230.227.196:19181 claims same Node ID (C407FA1E 2B46223A 5A72B091 905D868F 5AF429B1) as /123.5.212.236:10796 ; node dropped as this might be an impersonation attack
[20:48:41] New node /89.176.220.30:21473 claims same Node ID (C43A3790 49C294D7 94BC5BAD DBD297B7 B78ACD42) as /88.121.147.159:12865 ; node dropped as this might be an impersonation attack
[20:48:48] New node /87.119.118.34:64469 claims same Node ID (C4173A27 5134D7BB 98916C39 A61513E9 ED7A7067) as /61.141.156.4:20884 ; node dropped as this might be an impersonation attack
[20:48:53] Node C41A5BBE 50D93143 EDC08374 230540D6 72F610BF changed address from /124.13.91.107:8552 to /87.247.249.150:9983
[20:49:20] New node /209.6.18.239:18003 claims same Node ID (C41D4812 04B2CDF9 2BEA5CE5 DDA9DE69 78A6B7A5) as /200.172.105.110:60013 ; node dropped as this might be an impersonation attack
[20:50:52] Node C41A5BBE 50D93143 EDC08374 230540D6 72F610BF changed address from /87.247.249.150:9983 to /218.170.53.140:24364
[20:51:23] Node C41A8EFB C2F7AEB5 8AFACD1E 3E50B5E8 9A53A763 changed address from /89.215.185.163:12836 to /201.235.141.142:19850
[20:52:32] Node C8312C88 BDAFD659 18763B3E 7385EDC9 2A99D2AF changed address from /117.12.213.116:1108 to /117.12.213.116:1031
[20:52:52] New node /156.34.90.179:9544 claims same Node ID (C407FA1E 2B46223A 5A72B091 905D868F 5AF429B1) as /123.5.212.236:10796 ; node dropped as this might be an impersonation attack
[20:53:18] New node /87.126.91.56:24670 claims same Node ID (C4EEEC34 8930B75F A44B61B0 FC9CA196 991E58FC) as /81.88.114.195:42804 ; node dropped as this might be an impersonation attack
[20:53:31] Node C414AE6E F9A99411 501B1257 7BEAFBDB 73B4C549 changed address from /80.7.244.102:1167 to /189.25.67.101:60531
[20:55:42] Node BBFF56AA 114779F6 D175C678 3AA6B2A2 B9A8EEBD changed address from /218.82.81.121:1999 to /58.33.109.207:1219
[20:55:49] Node C449ACE1 952A488A 64AA4A3D 59D9D0B4 1F4A7039 changed address from /77.93.13.116:13918 to /121.19.204.209:55382
[20:55:53] New node /58.8.125.16:19746 claims same Node ID (C43A3790 49C294D7 94BC5BAD DBD297B7 B78ACD42) as /88.121.147.159:12865 ; node dropped as this might be an impersonation attack</code></pre></div><p>This is a trace we generate when a packet with a different source address than the currently stored node arrives. When that happens we send a ping-probe to the original node to see if it&#039;s still alive. If it is then it&#039;s assumed to be an impersonation attack (to prevent bucket poisoning), otherwise the address is adjusted.</p><p>I&#039;m not quite sure what&#039;s happening here, but i suspect that some clients are seriously misbehaving, as changing their IP to another continent (i did a few ipwhois lookups) while the old one is still available seems... let&#039;s say unlikely.<br />I&#039;d like others to verify this issue (after all, my detection code could be faulty)... and any ideas why this is happening?</p><br /><p>b) defining node timeouts</p><p>Unless i missed it the spec does not contain any values when nodes should be considered stale or bad. At least default guidelines should be specified.<br />For the mainline DHT plugin we&#039;re currently using:<br />last seen &gt; 15 minutes = stale<br />failed requests &gt; 8 = bad<br />last seen &gt; 15 minutes &amp;&amp; failed requests &gt; 2 = bad</p><p>[bad = eligible for immediate replacement, stale = must be pinged before it is replaced]</p><p>c) things about kademlia that should be mentioned explicitly</p><p>replacement buckets/passive routing table maintenance, especially the parts mentioned in chapter 4.1 in the <a href="http://infinite-source.de/az/whitepapers/kademlia_optimized.pdf">newer paper version</a> (the BEP links to the older one)</p>
						<p class="postedit"><em>Last edited by The 8472 (2008-04-21 12:43:53)</em></p>
					</div>
					<div class="postsignature postmsg"><hr /><p>Az dev</p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p169" class="blockpost rowodd">
	<h2><span><span class="conr">#5</span> <a href="viewtopic.php?pid=169#p169">2008-04-29 12:55:24</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89601">dave</a></strong></dt>
						<dd class="usertitle"><strong>Editor</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>I have asked Drue Loewenstern, Greg Hazel and Arvid Norberg to review your comments about the DHT.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p179" class="blockpost roweven">
	<h2><span><span class="conr">#6</span> <a href="viewtopic.php?pid=179#p179">2008-04-30 14:24:54</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89666">camrdale</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>The 8472 writes:<br />&gt; In addition the either peers or nodes response policy (&quot;If the queried node<br />&gt; has no peers for the infohash, a key &quot;nodes&quot; is returned containing the K<br />&gt; nodes in the queried nodes routing table closest to the infohash supplied in<br />&gt; the query.&quot;) should be changed to: always nodes, peers if available. This<br />&gt; should improve routing performance, especially if the node cannot supply a<br />&gt; sufficient amount of peers to satisfy the requesting peer, although the<br />&gt; packet size might become problematic then... any opinions?</p><p>I had a similar idea for another Kademlia-based DHT I&#039;m working on, and packet size did indeed become a problem. I solved it by breaking up the &quot;get_peers&quot; operation into two parts: &quot;find_peers&quot; would always return nodes as well as the number of peers it has for that key, and &quot;get_peers&quot; which would actually return the peers (could also add an optional parameter to &quot;get_peers&quot; specifying the maximum number of peers to return). The finding of peers is then a 2-step operation similar to the find_node/announce_peer operation, but it gives the client much more flexibility in which nodes to request peers from.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p194" class="blockpost rowodd">
	<h2><span><span class="conr">#7</span> <a href="viewtopic.php?pid=194#p194">2008-05-03 11:26:29</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89618">The 8472</a></strong></dt>
						<dd class="usertitle"><strong>Azureus Developer</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>I collected further evidence that we should guard more against crappy implementations, for example libtorrent seems to send announces multiple times (already notified arvid about this):</p><div class="codebox"><pre><code>[20:10:42] RPC received message [123.15.0.165] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:C version:LT targetKey:C41A4833 825A4B8C 26090FBD 053628A0 D22F319C (17)
[20:10:42] RPC send Message: [123.15.0.165] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:C
[20:10:44] RPC received message [123.15.0.165] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:t version:LT targetKey:C41A4833 825A4B8C 26090FBD 053628A0 D22F319C (17)
[20:10:44] RPC send Message: [123.15.0.165] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:t
[20:10:46] RPC received message [124.117.146.157] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:ï¿½ version:LT targetKey:C5366CF1 7DBC6933 193CD77C 7EFC732B 6532346A (8)
[20:10:46] RPC send Message: [124.117.146.157] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:ï¿½
[20:10:46] RPC received message [124.117.146.157] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:ï¿½ version:LT targetKey:C5366CF1 7DBC6933 193CD77C 7EFC732B 6532346A (8)
[20:10:46] RPC send Message: [124.117.146.157] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:ï¿½
[20:10:47] RPC received message [67.186.193.13] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:ï¿½=ï¿½Cï¿½ï¿½ï¿½ targetKey:C46F4AA4 401C6240 93E588BA 015128D3 A94C963F (10)
[20:10:48] RPC received message [203.218.188.174] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:ï¿½Fzï¿½6ï¿½-# targetKey:C4EADE87 F515E739 9BD8E577 28BBE778 7039C268 (9)
[20:10:48] RPC send Message: [203.218.188.174] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:ï¿½Fzï¿½6ï¿½-#
[20:10:48] RPC received message [211.92.142.104] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:U version:LT targetKey:C418A3CE DD8BEB33 5954293B B4A4B3C1 2BAF2991 (15)
[20:10:48] RPC send Message: [211.92.142.104] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:U
[20:10:48] RPC received message [124.117.146.157] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:= version:LT targetKey:C5366CF1 7DBC6933 193CD77C 7EFC732B 6532346A (8)
[20:10:48] RPC send Message: [124.117.146.157] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:=
[20:10:49] RPC received message [85.58.128.39] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:ï¿½ï¿½rï¿½ï¿½ targetKey:C42A1205 6D0483D1 B635B95F C4B23B7B 70BFC017 (11)
[20:10:49] RPC send Message: [85.58.128.39] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:ï¿½ï¿½rï¿½ï¿½
[20:10:49] RPC received message [61.173.33.127] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:ï¿½ version:LT targetKey:C41A4833 825A4B8C 26090FBD 053628A0 D22F319C (17)
[20:10:49] RPC send Message: [61.173.33.127] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:ï¿½
[20:10:51] RPC received message [61.173.33.127] Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:ï¿½ version:LT targetKey:C41A4833 825A4B8C 26090FBD 053628A0 D22F319C (17)
[20:10:51] RPC send Message: [61.173.33.127] Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:ï¿½</code></pre></div><p>and some peers are just ultra-spammy:</p><div class="codebox"><pre><code>[21:04:50.016] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.063] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.063] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.125] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.125] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.250] {plug} [Mainline DHT] RPC received message [58.37.203.202]  Method:GET_PEERS Type:REQ_MSG MessageID:/ï¿½eï¿½ï¿½oï¿½  targetKey:C437E3D6 1594DF78 BD955C49 860B4463 C4B46213 (11)
[21:04:50.359] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.375] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.375] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.391] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:	  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.406] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:
  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.422] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.484] {plug} [Mainline DHT] RPC received message [84.30.213.161]  Method:GET_PEERS Type:REQ_MSG MessageID:  targetKey:C43CF44B D5042168 12C9186B 5266A585 45BFB619 (11)
[21:04:50.484] {plug} [Mainline DHT] RPC received message [125.163.210.230]  Method:GET_PEERS Type:REQ_MSG MessageID:ï¿½ version:LT  targetKey:C41A4833 825A4B8C 26090FBD 053628A0 D22F319C (17)
[21:04:50.500] {plug} [Mainline DHT] RPC received message [98.165.149.123]  Method:GET_PEERS Type:REQ_MSG MessageID:J+</code></pre></div><p>I&#039;ve also seen (at least once) a bunch of get peers coming from different source IPs within milliseconds that look for the same target keys and incrementing message IDs, which obviously means someone is using source address spoofing... for what reason soever.</p><p>----</p><p>Then i&#039;m also seeing announces that seem too far from my local key. The number in brackets behind the target key indicates the bucket number where 0 is the root. I have buckets 0-19 filled and 20 partially filled. Since an announce should only happen on the closest 8 nodes that means announces in the buckets 18-20 would seem reasonable, especially considering that the keyspace covered roughly doubles with each bucket.</p><p>But i regularly see announces for buckets as low as 9 and occasionally even further away ones from nodes that don&#039;t send a version. Peers sending a version are LT and UT. LT peers somehow often get to bucket 17 - although many of the samples repeated themselves, see above. But i saw at least one LT request going to bucket 7, meaning it probably could use a better route finding algorithm too.<br />UT peers hit the target bucket 20 with good accuracy.</p><br /><div class="codebox"><pre><code>[21:13:56.922] {plug} [Mainline DHT] RPC received message [89.171.134.250]  Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:&#039;ï¿½ï¿½ï¿½Gï¿½0q  targetKey:C47B550A A73E8CEA B15438DD B2657910 FDC24F02 (10)
[21:13:56.938] {plug} [Mainline DHT] RPC send Message: [89.171.134.250]  Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:&#039;ï¿½ï¿½ï¿½Gï¿½0q  
[21:13:57.188] {plug} [Mainline DHT] RPC received message [220.140.115.7]  Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:&quot;?8&amp;ï¿½×¢9  targetKey:C417F9B9 F8C98B5B 2AEF4A30 557BE71B C4704980 (13)
[21:13:57.188] {plug} [Mainline DHT] RPC send Message: [220.140.115.7]  Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:&quot;?8&amp;ï¿½×¢9  
[21:13:57.359] {plug} [Mainline DHT] RPC received message [193.16.157.102]  Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:ï¿½NXï¿½w5ï¿½3  targetKey:C48D510D 320E3D90 A8583354 07EE3227 A4F5D32D (9)
[21:13:57.359] {plug} [Mainline DHT] RPC send Message: [193.16.157.102]  Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:ï¿½NXï¿½w5ï¿½3  
[21:13:58.641] {plug} [Mainline DHT] RPC received message [87.220.13.230]  Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:ï¿½ï¿½ï¿½ï¿½?t  targetKey:C4013D98 E75BB165 027BF9BC 057B29A6 0022A78E (12)
[21:13:58.641] {plug} [Mainline DHT] RPC send Message: [87.220.13.230]  Method:ANNOUNCE_PEER Type:RSP_MSG MessageID:ï¿½ï¿½ï¿½ï¿½?t  
[21:13:58.797] {plug} [Mainline DHT] RPC received message [59.173.207.8]  Method:ANNOUNCE_PEER Type:REQ_MSG MessageID:h</code></pre></div>
						<p class="postedit"><em>Last edited by The 8472 (2008-05-03 11:33:22)</em></p>
					</div>
					<div class="postsignature postmsg"><hr /><p>Az dev</p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p244" class="blockpost roweven">
	<h2><span><span class="conr">#8</span> <a href="viewtopic.php?pid=244#p244">2008-06-03 01:28:13</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89618">The 8472</a></strong></dt>
						<dd class="usertitle"><strong>Azureus Developer</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>Since things seem to move at glacial speeds.. here&#039;s the proposal:</p><br /><p>-- enforcing target closeness</p><p>To make sure that bad implementations do not store values in inappropriate keyspace locations (i.e. not close enough to the target) the store-token in a getPeers response should only provided when we feel responsible for the incoming getPeers request.</p><p>This can be calculated the following way:<br />With k-sized buckets we take our k * 3 closest nodes and calculate the distance between us and the farthest of these nodes. For an incoming getPeers request we calculate the distance between us and the target. If the distance is smaller (i.e. sharing more prefix bits) we send the token, otherwise we don&#039;t.</p><p>The rationale behind k*3 is that we cover our local bucket and one to the left and one to the right from the tree perspective.</p><p>-- preventing announce hammering (get and put)</p><p>this one is more complex, so it probably should be an optional feature if one wants to reduce unnecessary traffic even further. With an announce interval of 30 minutes a peer should not announce more often for a specific key every 15 minutes. Checking who announced within the last 15 minutes can be done either by a recently-seen list or 2 dynamically sized bloom filters that are swapped every 15 minutes.</p><p>If a node already announced within the last 15 minutes we have two options:<br />1a) send an error packet<br />1b) only send a node list (no token, no peers)</p><p>1a) is stricter and should make faulty implementations more obvious to their developers but might result in unexpected behavior due to aggressive error handling</p><p>For announce frequency tracking we also have 2 options:<br />2a) track on a per-node basis<br />2b) track on a per-&lt;node,key&gt; basis</p><p>2a) is cleaner, 2b) would also prevent generic hammering (not key-specific) but should only be combined with 1b) to prevent any potential routing problems. I&#039;m not quite sure if 2b) would be necessary/useful.</p><br /><p>---------</p><br /><p>Edit: </p><p>I&#039;ve been considering this further: Since a node returns <em>either</em> a peer list <em>or</em> a node list it means that storing a single value in nodes which are not really responsible for that key that this node will only return 1 peer and no nodes. Which basically takes one node out of a getPeers lookup process.<br />If done correctly &quot;around&quot; the perimeter of the nodes that would actually be responsible this could be seen as a denial of service attack, cutting off routes towards destination keys.<br />While probably not very effective it would at least lower the overall efficiency of the DHT for that key in particular.</p>
						<p class="postedit"><em>Last edited by The 8472 (2008-06-03 09:56:10)</em></p>
					</div>
					<div class="postsignature postmsg"><hr /><p>Az dev</p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p644" class="blockpost rowodd">
	<h2><span><span class="conr">#9</span> <a href="viewtopic.php?pid=644#p644">2009-10-09 03:20:19</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89618">The 8472</a></strong></dt>
						<dd class="usertitle"><strong>Azureus Developer</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>I&#039;ll list some ideas on: <br />1. IPv6 support for DHT routing<br />2. IPv6 support for DHT announces<br />3. Generic put and get operations and how announce/getpeers should be integrated with those</p><p>In addition to that i already explained how to combat crappy implementations which don&#039;t perform put operations on the right target nodes in the <a href="http://forum.bittorrent.org/viewtopic.php?pid=244#p244">previous post</a> but it needs a little fixing of the specification.</p><p><strong>Changing the spec to allow peers to deny inappropriate stores</strong></p><p>All that&#039;s really necessary is changing the spec to allow peers not to send a &quot;token&quot; if they consider the &quot;info_hash&quot;-target ID too far from their own buckets.</p><br /><p><strong>IPv6 support for DHT routing</strong></p><p>The fundamental problem with IPv6 and IPv4 is that right now there are many v4-only nodes, in the future there&#039;ll be many dual-stack nodes and even further in the future there&#039;ll be many v6-only nodes.</p><p>To solve this and allow us to make a clean cut at some point i propose that a DHT node should maintain 1 routing table per IP version. So a dualstack node will have 2 routing tables. One will only contain v4 and the other v6 addresses.</p><p>And here comes the interesting part: To allow smooth transitions between both the node-lists in FIND_NODE and GET_PEERS <em>responses</em> should return a &quot;nodes&quot; and a &quot;nodes2&quot; list (as proposed by <a href="http://www.rasterbar.com/products/libtorrent/dht_extensions.html">libtorrent</a>) from both routing tables, regardless of protocol.</p><p>This allows v6 nodes to gather other v6 contacts as a by-product of v4 lookups (and vice versa in the far future).</p><p><strong>IPv6 support for DHT announces</strong></p><p>Note that in the chapter above only &quot;nodes&quot; lists for FIND_NODE and GET_PEERS <em>responses</em> are covered. Lookups, i.e. outgoing <em>requests</em> should be handled differently to make sure that whichever address type is in the minority does not get drowned out by the majority.</p><p>To achieve this<br />a) the routing table management (PING, FIND_NODE) should be completely separate for both routing tables.<br />b) ANNOUNCE_PEER and GET_PEERS has to be performed in parallel but separate for each routing table.</p><p>Since announces are done once for v4 and once for v6 the source-address can still be used to determine the IP and no special measure has to be taken to announce the v6 address.</p><br /><p><strong>Generic put and get operations and how announce/getpeers should be integrated with those</strong></p><p>The names &quot;announce_peer&quot; and &quot;get_peers&quot; should be retained for backwards compatibility purposes but their semantics should be changed to generic put/get operations.</p><p>To do so all nodes aware of this extension should use &quot;target&quot; in addition to &quot;info_hash&quot; in their GET_PEERS requests.</p><p>If an extension-aware node receives such a request and would normally reply with a &quot;values&quot; list (peers) they should reply with 2 lists instead: &quot;orig&quot; (for origin node addresses) and &quot;data&quot; (e.g. ports for announces or whatever you store with a generic put).<br />If it would normally reply with a &quot;nodes&quot; (and &quot;nodes2&quot;) list it should add an empty &quot;orig&quot; and &quot;data&quot; list.</p><br /><p>Once a peer has received the GET_PEERS responses they should be able to determine if the other node understands the new new semantics based on the presence of &quot;orig&quot; and &quot;data&quot; keys.</p><p>Thus it sould send an ANNOUNCE_PEERS with &quot;target&quot; and &quot;data&quot; instead of &quot;info_hash&quot; and &quot;port&quot; to a compatible node. The target node would then take the originator&#039;s IP and the data and store them.<br />If a non-compatible node asks for the data they&#039;ll just pack the originator IP and the data (or if the semantics for &quot;data&quot; change: the port contained within &quot;data&quot;) into a &quot;values&quot; list. If a compatible peer asks for the data they&#039;ll put them into &quot;data&quot; and &quot;orig&quot; lists instead.</p><br /><br /><br /><p>Bittorent announces would be done to target=infohash, anything else could go to sha1(&quot;of some key you want to store&quot;), e.g. sha1(&quot;metadataXYZ&quot;+info_hash) if you want to store some specific metadata about a torrent.</p><br /><p>At some point in the future we could just cut out all the code handling &quot;info_hash&quot;, &quot;port&quot; and &quot;values&quot; and only use &quot;target&quot;, &quot;orig&quot; and &quot;data&quot; and thus live legacy-free. New semantics for data could be handled by simply doing the lookups to different &quot;target&quot; IDs and/or by using bencoded dicts within the data.</p>
					</div>
					<div class="postsignature postmsg"><hr /><p>Az dev</p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p645" class="blockpost roweven">
	<h2><span><span class="conr">#10</span> <a href="viewtopic.php?pid=645#p645">2009-10-12 13:18:03</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=90580">jch</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>For those who don&#039;t know me -- I&#039;m the author of Transmission&#039;s DHT code.</p><p><strong>IPv6 support for the DHT</strong></p><p><em>a DHT node should maintain 1 routing table per IP version</em></p><p>This cannot be stressed enough.&#160; Kademlia requires transitive connectivity; this breaks if you put both IPv4 and IPv6 nodes in a single table.&#160; Hence, any double-stack node <strong>must maintain two distinct routing tables</strong>, one for IPv4 and one for IPv6.</p><p>There was some discussion on the subject in <a href="http://forum.utorrent.com/viewtopic.php?id=53492">http://forum.utorrent.com/viewtopic.php?id=53492</a> .</p><p><em>To allow smooth transitions between both the node-lists in FIND_NODE and GET_PEERS responses should return a &quot;nodes&quot; and a &quot;nodes2&quot; list</em></p><p>I find that confusing.&#160; I would rather suggest that the lists should be:</p><p>* <strong>nodes</strong> for the current address family (IPv4 in an IPv4 message, IPv6 in an IPv6 message);<br />* <strong>nodes4</strong> or <strong>nodes6</strong> for the other address family.</p><p>Hence, a message will either have just a nodes list (for legacy peers), both nodes and nodes6 (for an IPv4 message) or both nodes and nodes4 (for an IPv6 message).</p><p>Additionally, I would suggest that not all replies carry the nodes4 or nodes6 message; I would suggest that a find_nodes request should carry a boolean flag that explicitly requests nodes from the other family.</p><p><em>Since announces are done once for v4 and once for v6 the source-address can still be used to determine the IP and no special measure has to be taken to announce the v6 address.</em></p><p>Fully agreed.</p><p>--Juliusz</p>
						<p class="postedit"><em>Last edited by jch (2009-10-12 13:26:04)</em></p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p646" class="blockpost rowodd">
	<h2><span><span class="conr">#11</span> <a href="viewtopic.php?pid=646#p646">2009-10-12 13:20:11</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=90580">jch</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p><strong>Generic put and get operations</strong></p><p>As noted in private mail, I&#039;m currently opposed to this proposal (but quite willing to change my mind if new information is provided).</p><p>In particular, you should recall that unlike Azureus, Transmission is used on embedded systems with very little memory (notably OpenWRT machines).&#160; Hence, any proposal that causes us to track unbounded amounts of memory is a strict no for me.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p647" class="blockpost roweven">
	<h2><span><span class="conr">#12</span> <a href="viewtopic.php?pid=647#p647">2009-10-12 13:23:05</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=90580">jch</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p><em>Peers sending a version are LT and UT</em></p><p>Just to set the record straight -- Transmission also sends a version (&quot;TR&quot; plus the big-endian binary encoding of the SVN revision number). Please drop me a mail if you see any such gross mis-behaviour coming from Transmission peers.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p649" class="blockpost rowodd">
	<h2><span><span class="conr">#13</span> <a href="viewtopic.php?pid=649#p649">2009-10-13 10:57:29</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89618">The 8472</a></strong></dt>
						<dd class="usertitle"><strong>Azureus Developer</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>I am convinced that my proposal provides a viable approach to the problem(s). Things like key names are minor issues and can be changed for sure. Although i find nodes + nodes2 (or nodes6 if you wish) better for reasons of parsing simplicity as the message decoder does not have to be aware of which routing table it belongs to.</p><p>Including want4/want6 in requests to cut down on the amount of send node infos makes sense.</p><br /><p>The only part i&#039;m not certain about is using originators + data to provide maximum similarity in the semantics compared to the current implementation as it would reduce the amount of data you can fit into a single generic get reply if you don&#039;t really care about the originators.</p><br /><p>Thus i would request review and comments on this post:</p><p><a href="http://forum.bittorrent.org/viewtopic.php?pid=644#p644">http://forum.bittorrent.org/viewtopic.php?pid=644#p644</a></p>
					</div>
					<div class="postsignature postmsg"><hr /><p>Az dev</p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p651" class="blockpost roweven">
	<h2><span><span class="conr">#14</span> <a href="viewtopic.php?pid=651#p651">2009-10-14 12:39:05</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=90580">jch</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<div class="quotebox"><blockquote><div><p>Although i find nodes + nodes2 (or nodes6 if you wish) better for reasons of parsing simplicity as the message decoder does not have to be aware of which routing table it belongs to.</p></div></blockquote></div><p>I prefer it, but don&#039;t care very much -- let&#039;s avoid getting into a bikeshed argument for the moment.<br /></p><div class="quotebox"><blockquote><div><p>Including want4/want6 in requests to cut down on the amount of send node infos makes sense.</p></div></blockquote></div><p>It&#039;s absolutely essential.&#160; My plan is to only include want* when bootstrapping.&#160; Having nodes send the other address family by default would double traffic with little or no benefit.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p652" class="blockpost rowodd">
	<h2><span><span class="conr">#15</span> <a href="viewtopic.php?pid=652#p652">2009-10-14 12:41:54</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=90580">jch</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<div class="quotebox"><blockquote><div><p>The only part i&#039;m not certain about is using originators + data</p></div></blockquote></div><p>I suggest we stick to IPv6 for now, and not discuss the generic data extension for now.</p><p>By the way -- could somebody get some ÂµTorrent developer into the discussion?</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p653" class="blockpost roweven">
	<h2><span><span class="conr">#16</span> <a href="viewtopic.php?pid=653#p653">2009-10-14 15:20:16</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=90580">jch</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>Okay, here&#039;s a mostly complete proposal:</p><p>&#160; <a href="http://www.pps.jussieu.fr/~jch/software/bittorrent/bep-dht-ipv6.html">http://www.pps.jussieu.fr/~jch/software … -ipv6.html</a></p><p>In short:</p><p>* I&#039;ve adopted The8472&#039;s semantics for nodes/nodes6;<br />* I&#039;ve merged the &quot;want4&quot; and &quot;want6&quot; fields into a single &quot;want&quot; field;<br />* I&#039;ve added a note about how this solves the problem of get_peers not returning nodes information in some cases, without breaking compatibility.</p>
						<p class="postedit"><em>Last edited by jch (2009-10-14 15:26:38)</em></p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p654" class="blockpost rowodd">
	<h2><span><span class="conr">#17</span> <a href="viewtopic.php?pid=654#p654">2009-10-14 17:55:19</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89618">The 8472</a></strong></dt>
						<dd class="usertitle"><strong>Azureus Developer</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>Hrrm, i have some thoughts on this.</p><p>I agree that generic storage wouldn&#039;t be good at this point since the mainline DHT lacks features to deal with it.</p><br /><p><strong>Want flags</strong></p><br /><p>We should reconsider the want-field though. requests generally are small as they don&#039;t carry any payload, so we have a bit more room to spare. Using a string of characters and decoding individual characters as features sounds just horrible (Ph&#039;nglui mglw&#039;nafh Cthulhu R&#039;lyeh wgah&#039;nagl fhtagn!) from a coordination standpoint.</p><p>Since those messages are bencoded anyway i would suggest encoding the list as &quot;flags&quot; instead of &quot;want&quot; as a list of bencoded strings.</p><p>&quot;rV6n&quot; and &quot;rV4n&quot;&#160; (for requesting v4/6 nodes) as flags in that list should be sufficiently short. and cause a lot less clashes as having only 256 possible characters available.</p><p>example: d.....5:flagsl4:rV6n4:rV4Ne......e</p><br /><p><strong>Tokens</strong></p><br /><p>I know this is completely orthogonal to IPv6 compatibility, but since we&#039;re tweaking the protocol i&#039;d really like the spec to be changed nodes can officially omit the token as a way to indicate that they will not service a store request. Silently dropping store requests is already possible, but we have no way for the requesting node to know that and thus they can&#039;t adjust their routing properly.</p><br /><p><strong>node IDs, pings</strong><br />You write that they can have separate IDs for the v6 and v4 nodes. I think that unnecessarily complicates the possible combinations and would require us to add something like ID6 to ping responses or do similar things.</p><p>Having identical IDs also increases the synergies that one routing tables will have from the node info leaked through the other one</p>
					</div>
					<div class="postsignature postmsg"><hr /><p>Az dev</p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p656" class="blockpost roweven">
	<h2><span><span class="conr">#18</span> <a href="viewtopic.php?pid=656#p656">2009-10-15 14:00:07</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89602">arvid</a></strong></dt>
						<dd class="usertitle"><strong>Administrator</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>I agree that the &quot;token&quot; should be an optional way of indicating that the data searched for is ok to store on that node.</p><p>I also think that the specification should be updated to always return nodes on a get_peers request.</p><p>@jch: you seemed to have some reservation about returning &quot;nodes&quot; together with &quot;values&quot; to a get_peers request. What is your concern with doing that?</p><p>I agree that the node-id should be the same for the two routing tables. I put up the draft for this proposal as BEP 32, let&#039;s move discussion about this into its own forum thread under BEP 32.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p657" class="blockpost rowodd">
	<h2><span><span class="conr">#19</span> <a href="viewtopic.php?pid=657#p657">2009-10-15 14:14:23</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=90580">jch</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>&gt; @jch: you seemed to have some reservation about returning &quot;nodes&quot; together with &quot;values&quot; to a get_peers request. What is your concern with doing that?</p><p>How do existing implementations parse a get_peers reply?&#160; I can see three reasonable ways:</p><p>1. parse both nodes and values if they are present.&#160; (This is what Transmission does.)<br />2. check for values, and if it is absent, check for nodes.<br />3. check for nodes, and if it is absent, check for values.</p><p>If you unconditionally send nodes together with values, you&#039;ll interoperate with implementations that do (1) or (2), but you&#039;ll break implementations that do (3).&#160; Before we decide on sending nodes together with values, I want us to check that there is no widely-deployed implementation that does (3).</p><p>In particular, there&#039;s no way I&#039;m going to implement that in Transmission unless I have a positive answer from somebody who has access to the ÂµTorrent code.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p658" class="blockpost roweven">
	<h2><span><span class="conr">#20</span> <a href="viewtopic.php?pid=658#p658">2009-10-15 14:16:53</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=90580">jch</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>&gt; i&#039;d really like the spec to be changed nodes can officially omit the token as a way to indicate that they will not service a store request.</p><p>No objection.&#160; I won&#039;t be sending token-less replies in Transmission (I prefer to simply drop the announce_peers request), but I will be parsing token-less replies in the next version.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p661" class="blockpost rowodd">
	<h2><span><span class="conr">#21</span> <a href="viewtopic.php?pid=661#p661">2009-10-15 14:41:22</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89602">arvid</a></strong></dt>
						<dd class="usertitle"><strong>Administrator</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>uTorrent has done this since a bit over a year now. Both sent &quot;nodes&quot; in &quot;get_peer&quot; requests as well as handle both &quot;nodes&quot; and &quot;values&quot; in the response. So has libtorrent (i.e. Deluge, Qbittorrent, Miro, Limewire, Halite, etc.).</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p665" class="blockpost roweven">
	<h2><span><span class="conr">#22</span> <a href="viewtopic.php?pid=665#p665">2009-10-15 15:02:47</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89618">The 8472</a></strong></dt>
						<dd class="usertitle"><strong>Azureus Developer</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>new thread: <a href="http://forum.bittorrent.org/viewtopic.php?id=114">http://forum.bittorrent.org/viewtopic.php?id=114</a></p>
					</div>
					<div class="postsignature postmsg"><hr /><p>Az dev</p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p670" class="blockpost rowodd">
	<h2><span><span class="conr">#23</span> <a href="viewtopic.php?pid=670#p670">2009-10-15 16:09:22</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=90580">jch</a></strong></dt>
						<dd class="usertitle"><strong>Member</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<div class="codebox"><pre><code>dht-0.10: unreleased

  * Send nodes even when sending values.  This is a violation of the
    protocol, but I have been assured that it doesn&#039;t break any deployed
    implementation.  This is also what both libtorrent and uTorrent do.
  * Give up immediately on a search peer when no token was provided.  This
    is a very reasonable extension to the protocol, and certainly doesn&#039;t
    break anything.</code></pre></div><p>This should be in Transmission 1.80, unless I change my mind.</p>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p671" class="blockpost roweven">
	<h2><span><span class="conr">#24</span> <a href="viewtopic.php?pid=671#p671">2009-10-15 16:30:03</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89602">arvid</a></strong></dt>
						<dd class="usertitle"><strong>Administrator</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>Here are my proposed changes:</p><div class="codebox"><pre class="vscroll"><code>Index: bep_0005.rst
===================================================================
--- bep_0005.rst	(revision 11179)
+++ bep_0005.rst	(working copy)
@@ -332,18 +332,20 @@
 querying node, and &quot;info_hash&quot; containing the infohash of the torrent.
 If the queried node has peers for the infohash, they are returned in a
 key &quot;values&quot; as a list of strings. Each string containing &quot;compact&quot; format
-peer information for a single peer. If the queried node has no
-peers for the infohash, a key &quot;nodes&quot; is returned containing the K
+peer information for a single peer. A key &quot;nodes&quot; is also returned containing the K
 nodes in the queried nodes routing table closest to the infohash
-supplied in the query. In either case a &quot;token&quot; key is also included in
-the return value. The token value is a required argument for a future
+supplied in the query. If the &quot;nodes&quot; key brings the packet size over the UDP MTU,
+fewer than K nodes may be returned. A &quot;token&quot; key may also be included in
+the return value to signal the requesting node that it can store data in the
+requested peer. The token value is a required argument for a future
 announce_peer query. The token value should be a short binary string.
 
 ::
 
   arguments:  {&quot;id&quot; : &quot;&lt;querying nodes id&gt;&quot;, &quot;info_hash&quot; : &quot;&lt;20-byte infohash of target torrent&gt;&quot;}
 
-  response: {&quot;id&quot; : &quot;&lt;queried nodes id&gt;&quot;, &quot;token&quot; :&quot;&lt;opaque write token&gt;&quot;, &quot;values&quot; : [&quot;&lt;peer 1 info string&gt;&quot;, &quot;&lt;peer 2 info string&gt;&quot;]}
+  response: {&quot;id&quot; : &quot;&lt;queried nodes id&gt;&quot;, &quot;nodes&quot; : &quot;&lt;compact node info&gt;&quot;
+    , &quot;token&quot; :&quot;&lt;opaque write token&gt;&quot;, &quot;values&quot; : [&quot;&lt;peer 1 info string&gt;&quot;, &quot;&lt;peer 2 info string&gt;&quot;]}
 
   or: {&quot;id&quot; : &quot;&lt;queried nodes id&gt;&quot;, &quot;token&quot; :&quot;&lt;opaque write token&gt;&quot;, &quot;nodes&quot; : &quot;&lt;compact node info&gt;&quot;}
 
@@ -357,13 +359,13 @@
 
 ::
 
-  Response with peers = {&quot;t&quot;:&quot;aa&quot;, &quot;y&quot;:&quot;r&quot;, &quot;r&quot;: {&quot;id&quot;:&quot;abcdefghij0123456789&quot;, &quot;token&quot;:&quot;aoeusnth&quot;, &quot;values&quot;: [&quot;axje.u&quot;, &quot;idhtnm&quot;]}}
-  bencoded = d1:rd2:id20:abcdefghij01234567895:token8:aoeusnth6:valuesl6:axje.u6:idhtnmee1:t2:aa1:y1:re
+  Response with peers = {&quot;t&quot;:&quot;aa&quot;, &quot;y&quot;:&quot;r&quot;, &quot;r&quot;: {&quot;id&quot;:&quot;abcdefghij0123456789&quot;, &quot;nodes&quot;:&quot;def456...&quot;, &quot;token&quot;:&quot;aoeusnth&quot;, &quot;values&quot;: [&quot;axje.u&quot;, &quot;idhtnm&quot;]}}
+  bencoded = d1:rd2:id20:abcdefghij01234567895:nodes9:def456...5:token8:aoeusnth6:valuesl6:axje.u6:idhtnmee1:t2:aa1:y1:re
 
 
 ::
 
-  Response with closest nodes = {&quot;t&quot;:&quot;aa&quot;, &quot;y&quot;:&quot;r&quot;, &quot;r&quot;: {&quot;id&quot;:&quot;abcdefghij0123456789&quot;, &quot;token&quot;:&quot;aoeusnth&quot;, &quot;nodes&quot;: &quot;def456...&quot;}}
+  Response with closest nodes = {&quot;t&quot;:&quot;aa&quot;, &quot;y&quot;:&quot;r&quot;, &quot;r&quot;: {&quot;id&quot;:&quot;abcdefghij0123456789&quot;, &quot;token&quot;:&quot;aoeusnth&quot;, &quot;nodes&quot;:&quot;def456...&quot;}}
   bencoded = d1:rd2:id20:abcdefghij01234567895:nodes9:def456...5:token8:aoeusnthe1:t2:aa1:y1:re</code></pre></div>
					</div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div id="p675" class="blockpost rowodd">
	<h2><span><span class="conr">#25</span> <a href="viewtopic.php?pid=675#p675">2009-10-15 17:20:06</a></span></h2>
	<div class="box">
		<div class="inbox">
			<div class="postbody">
				<div class="postleft">
					<dl>
						<dt><strong><a href="profile.php?id=89618">The 8472</a></strong></dt>
						<dd class="usertitle"><strong>Azureus Developer</strong></dd>
					</dl>
				</div>
				<div class="postright">
					<h3>Re: Discussion of BEP 5: DHT</h3>
					<div class="postmsg">
						<p>I suggest &quot;should&quot; instead of &quot;may&quot; in</p><p>&#039;A &quot;token&quot; key may also be included&#039;</p><p>As providing it generally should be the norm (at least for nodes that are close to the target) unless the node has some significant reason to not honor store requests.</p><p>The underlying reasoning why it is optional and yet important is not clear otherwise.</p>
					</div>
					<div class="postsignature postmsg"><hr /><p>Az dev</p></div>
				</div>
			</div>
		</div>
		<div class="inbox">
			<div class="postfoot clearb">
				<div class="postfootleft"><p><span>Offline</span></p></div>
			</div>
		</div>
	</div>
</div>

<div class="postlinksb">
	<div class="inbox crumbsplus">
		<div class="pagepost">
			<p class="pagelink conl"><span class="pages-label">Pages: </span><strong class="item1">1</strong> <a href="viewtopic.php?id=12&amp;p=2">2</a> <a href="viewtopic.php?id=12&amp;p=2">Next</a></p>
		</div>
		<ul class="crumbs">
			<li><a href="index.php">Index</a></li>
			<li><span>»&#160;</span><a href="viewforum.php?id=25">BEPs</a></li>
			<li><span>»&#160;</span><a href="viewtopic.php?id=12"><strong>Discussion of BEP 5: DHT</strong></a></li>
		</ul>
		<div class="clearer"></div>
	</div>
</div>
</div>

<div id="brdfooter" class="block">
	<h2><span>Board footer</span></h2>
	<div class="box">
		<div id="brdfooternav" class="inbox">
			<div class="conl">
			</div>
			<div class="conr">
				<p id="poweredby">Powered by <a href="http://fluxbb.org/">FluxBB</a></p>
			</div>
			<div class="clearer"></div>
		</div>
	</div>
</div>

</div>
<div class="end-box"><div><!-- Bottom corners --></div></div>
</div>

</body>
</html>
